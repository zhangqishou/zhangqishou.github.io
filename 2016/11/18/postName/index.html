<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>postName | zhangqishou&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;gt;我们日常应用中都离不开日志。可以说日志是我们在排查问题的一个重要依据。但是日志并不是写了就好了，当你想查看日志的时候，你会发现线上日志堆积的长度已经超越了你一行行浏览的耐性的极限了。于是，很有必要通过一些手段来高效地辅助你来快速的从日志中找到你要找的问题。本文通过一个从项目中衍生出来的例子从查找日志，筛选日志和统计日志3个方面层层递进来简述日志文件查看中一些有用的手段。（注：在linux环">
<meta property="og:type" content="article">
<meta property="og:title" content="postName">
<meta property="og:url" content="http://yoursite.com/2016/11/18/postName/index.html">
<meta property="og:site_name" content="zhangqishou's blog">
<meta property="og:description" content="&amp;gt;我们日常应用中都离不开日志。可以说日志是我们在排查问题的一个重要依据。但是日志并不是写了就好了，当你想查看日志的时候，你会发现线上日志堆积的长度已经超越了你一行行浏览的耐性的极限了。于是，很有必要通过一些手段来高效地辅助你来快速的从日志中找到你要找的问题。本文通过一个从项目中衍生出来的例子从查找日志，筛选日志和统计日志3个方面层层递进来简述日志文件查看中一些有用的手段。（注：在linux环">
<meta property="og:updated_time" content="2016-11-18T07:42:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="postName">
<meta name="twitter:description" content="&amp;gt;我们日常应用中都离不开日志。可以说日志是我们在排查问题的一个重要依据。但是日志并不是写了就好了，当你想查看日志的时候，你会发现线上日志堆积的长度已经超越了你一行行浏览的耐性的极限了。于是，很有必要通过一些手段来高效地辅助你来快速的从日志中找到你要找的问题。本文通过一个从项目中衍生出来的例子从查找日志，筛选日志和统计日志3个方面层层递进来简述日志文件查看中一些有用的手段。（注：在linux环">
  
    <link rel="alternate" href="/atom.xml" title="zhangqishou&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">zhangqishou&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-postName" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/18/postName/" class="article-date">
  <time datetime="2016-11-18T07:39:15.000Z" itemprop="datePublished">2016-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      postName
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&gt;<br>我们日常应用中都离不开日志。可以说日志是我们在排查问题的一个重要依据。但是日志并不是写了就好了，当你想查看日志的时候，你会发现线上日志堆积的长度已经超越了你一行行浏览的耐性的极限了。于是，很有必要通过一些手段来高效地辅助你来快速的从日志中找到你要找的问题。本文通过一个从项目中衍生出来的例子从查找日志，筛选日志和统计日志3个方面层层递进来简述日志文件查看中一些有用的手段。（注：在linux环境下）<br>&gt;</p>
<p><strong>例子背景</strong><br>后台跑一个定时任务，对指定时间段的订单数据表中的每一条记录进行以此任务处理。在日志中输出：</p>
<ol>
<li>订单id</li>
<li>订单处理状态</li>
<li>日志类别</li>
</ol>
<p><em>示例日志</em>  <code>demo.log</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">05</span>,<span class="number">012</span> [] INFO  bo.CommodityCerOrderBO - 当前正在处理页数:<span class="number">1</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>,<span class="number">688</span> [] INFO  bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>,<span class="number">709</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">31</span>,<span class="number">721</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>,<span class="number">727</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>,<span class="number">782</span> [] INFO  bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:attr_ids成功保存为<span class="number">0</span>|<span class="number">100104</span>|<span class="number">0</span>|<span class="number">100105</span>|<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>,<span class="number">782</span> [] INFO  bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10226</span>,status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>,<span class="number">805</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10226</span>,status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">33</span>,<span class="number">828</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10226</span>,status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div></pre></td></tr></table></figure>
<h3 id="1-一些最基础的日志查看命令"><a href="#1-一些最基础的日志查看命令" class="headerlink" title="1. 一些最基础的日志查看命令"></a>1. 一些最基础的日志查看命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. tail -400f demo.log <span class="comment">#监控最后400行日志文件的变化 等价与 tail -n 400 -f （-f参数是实时）</span></div><div class="line">2. less demo.log <span class="comment">#查看日志文件，支持上下滚屏，查找功能</span></div><div class="line">3. uniq -c demo.log  <span class="comment">#标记该行重复的数量，不重复值为1</span></div></pre></td></tr></table></figure>
<h3 id="2-查找关键日志记录-grep"><a href="#2-查找关键日志记录-grep" class="headerlink" title="2. 查找关键日志记录 grep"></a>2. 查找关键日志记录 grep</h3><p><code>规则：grep [选项]...模式 [文件]...    （模式是正则表达式）</code></p>
<p><strong>例子1：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -o <span class="string">'order-fix.curr_id:\([0-9]\+\)'</span> demo.log    <span class="comment">#-o选项只提取order-fix.curr_id:xxx的内容（而不是一整行），并输出到屏幕上</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">00</span>,<span class="number">610</span> [] INFO  bo.CommodityCerOrderBO - =====&gt;属性订正任务执行开始|每页读取<span class="number">100</span>条数据</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">05</span>,<span class="number">012</span> [] INFO  bo.CommodityCerOrderBO - 当前正在处理页数:<span class="number">1</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>,<span class="number">688</span> [] INFO  bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:attr_ids不含<span class="number">0</span>跳过</div><div class="line">...(略)</div></pre></td></tr></table></figure></p>
<p><strong>例子2：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -o <span class="string">'order-fix.curr_id:\([0-9]\+\)'</span> demo.log    <span class="comment">#-o选项只提取order-fix.curr_id:xxx的内容（而不是一整行），并输出到屏幕上</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">order-fix.curr_id:<span class="number">10117</span></div><div class="line">order-fix.curr_id:<span class="number">10117</span></div><div class="line">order-fix.curr_id:<span class="number">10117</span></div><div class="line">order-fix.curr_id:<span class="number">10117</span></div><div class="line">order-fix.curr_id:<span class="number">10117</span></div><div class="line">order-fix.curr_id:<span class="number">10226</span></div><div class="line">...(略)</div></pre></td></tr></table></figure></p>
<p><strong>例子3：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -c <span class="string">'ERROR'</span> demo.log   <span class="comment">#输出文件demo.log中查找所有包行ERROR的行的数量</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">17</span></div></pre></td></tr></table></figure></p>
<p><strong>例子4：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -v <span class="string">'ERROR'</span> demo.log   <span class="comment">#查找不含"ERROR"的行</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong> （功能和grep ‘INFO’ demo.log 命令一样，输出略）<br><em>注：</em> <a href="http://pic002.cnblogs.com/images/2010/165814/2010110910285741.png" target="_blank" rel="external">grep 用法小结：请点击直接查看</a></p>
<h3 id="3-精简日志内容-sed"><a href="#3-精简日志内容-sed" class="headerlink" title="3. 精简日志内容 sed"></a>3. 精简日志内容 sed</h3><p>从n多行的日志文件中提取到一定数量的行后，可能你还会觉得有些功能不够，比如你每行并不需要有哪个类抛出的描述，比如你不需要日志时间，或者要把时间格式换个形式展示等等，这时候你就可以通过sed的替换命令来进行对日志文件提取具体内容了。如果把grep比作过滤器，那sed就是个修改器了。</p>
<p><code>sed [-n][-e] &#39;命令&#39; 文件        #-n选项是默认不输出信息，除非使用了p命令或者是s命令的p标志符；-e是表明空格后面接的是一个命令</code><br><code>sed [-n] -f 脚本 文件           #这个用法是把命令写在脚本里</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">»<span class="string">'命令'</span>的格式： [地址1[,地址2]][!] 指令 [参数]</div><div class="line">                    » 地址的格式：用行号标识(1 表明匹配第一行)，或者用正则表达式匹配(<span class="string">'^INFO'</span>表明该地址匹配以INFO打头的行)</div><div class="line">                    » 指令的例子：p打印指令，s替换指令，d删除指令等等</div><div class="line"> ```                   </div><div class="line">![](~/23-53-15.jpg)</div><div class="line">**例1：**</div><div class="line"></div><div class="line">![](~/23-53-56.jpg)</div><div class="line"></div><div class="line">**例2：输出demo.log中的某个日期中的ERROR的行**</div><div class="line">```bash</div><div class="line">sed -n <span class="string">'/^2011-08-23.*ERROR/p'</span> demolog.log</div></pre></td></tr></table></figure>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>,<span class="number">709</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">31</span>,<span class="number">721</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>,<span class="number">727</span> [] ERROR bo.CommodityCerOrderBO - order-fix.curr_id:<span class="number">10117</span>,status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div></pre></td></tr></table></figure></p>
<p><strong>例3： 提取demo.log中的日期，日志级别，订单id和状态</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="_">-f</span> demo.sed2 demo.log</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#这一行用法和命令中的-n一样意思，就是默认不输出</span></div><div class="line"><span class="comment">#demo.sed2</span></div><div class="line"><span class="comment">#下面的一行是替换指令，就是把19位长的日期和INFO/ERROR,id,和后面的一截提取出来，然后用@分割符把这4个字段重新按顺序组合</span></div><div class="line">s/^\([-\: 0-9]\&#123;19\&#125;\).*\(INFO\|ERROR\) .*order-fix.curr_id:\([0-9]\+\),\(.*$\)/\1@\3@\2@\4/p</div></pre></td></tr></table></figure>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>@<span class="number">10117</span>@INFO@status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">31</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>@<span class="number">10117</span>@INFO@status:attr_ids成功保存为<span class="number">0</span>|<span class="number">100104</span>|<span class="number">0</span>|<span class="number">100105</span>|<span class="number">100107</span></div><div class="line">...略</div></pre></td></tr></table></figure></p>
<p>sed详细用法可以参考《sed 与 awk》(第二版), 或者man之<br>或者点击下面这个<a href="http://www.reddragonfly.org/abscn/x17814.html" target="_blank" rel="external">参考链接</a></p>
<h3 id="4-对记录进行排序-sort"><a href="#4-对记录进行排序-sort" class="headerlink" title="4. 对记录进行排序 sort"></a>4. 对记录进行排序 sort</h3><p>  经过了日志文件的精炼后，我们可能不想对日志进行时间排序，这时候我们就可以用sort进行排序。<br>  <code>sort [options] [file...]</code></p>
<p>  <strong>例1.对于demo.log，经过了上面的sed提取后，我希望先用id进行排序，然后再用日志级别倒序进行排序，最后才是日期排序</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#排序功能 -t表示用@作为分割符，-k表示用分割出来的第几个域排序(不要漏掉后面的,2/,3/,1，详细意思看下面的参考链接，这里不做详述)</span></div><div class="line">sed <span class="_">-f</span> test.sed demolog.log | sort -t@ -k2,2n -k3,3r -k1,1                  <span class="comment">#n为按数字排序，r为倒序</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>@<span class="number">10117</span>@INFO@status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>@<span class="number">10117</span>@INFO@status:attr_ids成功保存为<span class="number">0</span>|<span class="number">100104</span>|<span class="number">0</span>|<span class="number">100105</span>|<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">30</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">31</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span>@<span class="number">10117</span>@ERROR@status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">36</span>@<span class="number">10222</span>@INFO@status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">36</span>@<span class="number">10222</span>@ERROR@status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">36</span>@<span class="number">10222</span>@ERROR@status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div></pre></td></tr></table></figure></p>
<p>详尽手册<a href="http://ss64.com/bash/sort.html" target="_blank" rel="external">http://ss64.com/bash/sort.html</a></p>
<h3 id="5-统计日志相关记录数-awk"><a href="#5-统计日志相关记录数-awk" class="headerlink" title="5. 统计日志相关记录数 awk"></a>5. 统计日志相关记录数 awk</h3><p>现在日志已经比较清晰了，但是如果我想对不同日志进行统计怎么办，比如我要统计所有ERROR的日志记录书，或者要统计每个订单有多少个ERROR？这就需要我们的awk帮忙了。<br><code>awk [-v 变量名=变量值] [-Fre] [--] &#39;模式 { 语句 }&#39; 变量名=变量值 文件名</code><br><code>awk [-v 变量名=变量值] [-Fre] -f 脚本文件 [--] 变量名=变量值 文件名</code></p>
<p>和sed一样，awk也支持2中方式调用，一种是把awk脚本直接在命令行写入，第二种是把awk写在文件中在命令行中调用。</p>
<p>awk处理方式也与sed类似，对文件中的每一个输入行进行处理，每个处理首先判断是否是模式中匹配的行，是的话就具体执行相应的语句。</p>
<p>不同的是，awk侧重与对每一行的列进行处理，并且，awk脚本和c语言类似也拥有变量，条件判断，循环等复杂语句，所以这里只能简单介绍一下基本应用，详细的请查看后面给出的相关链接。而且，awk在处理所有行前和处理完行后各有BEGIN和END语句做预处理和后置处理。</p>
<p><strong>例子1：打印日志中的第2，3列</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">awk <span class="string">'BEGIN&#123;FS="@"&#125; &#123;print $2,$3&#125;'</span> demo.log_after_sort   <span class="comment">#BEGIN中预处理的是，把@号作为行的列分割符,把分割后的行的第2，3列输出</span></div></pre></td></tr></table></figure></p>
<p><strong>输出：（对于从sort得出的结果作为输入）</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">10117</span> INFO</div><div class="line"><span class="number">10117</span> INFO</div><div class="line"><span class="number">10117</span> ERROR</div><div class="line"><span class="number">10117</span> ERROR</div><div class="line"><span class="number">10117</span> ERROR</div><div class="line"><span class="number">10222</span> INFO</div><div class="line">...略</div></pre></td></tr></table></figure></p>
<p><strong>例子2. 统计日志中INFO，ERROR出现的总数,以及总记录数</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#下面的例子是作为命令行输入的，利用单引号作为换行标记，这样就不用另外把脚本写进文件调用了</span></div><div class="line">awk <span class="string">'</span></div><div class="line">BEGIN &#123;</div><div class="line">  FS="@"</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#123;</div><div class="line">  if ($3 == "INFO") &#123;info_count++&#125;</div><div class="line">  if ($3 == "ERROR") &#123;error_count++&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">END &#123;</div><div class="line">  print "order total count:"NR           #NR是awk内置变量，是遍历的当前行号，到了END区域自然行号就等于总数了</div><div class="line">  printf("INFO count:%d ERROR count:%d\n",info_count,error_count)</div><div class="line">&#125; ' demo.log_after_sort</div></pre></td></tr></table></figure></p>
<p><strong>输出：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">order total count:<span class="number">22</span></div><div class="line">INFO count:<span class="number">5</span> ERROR count:<span class="number">17</span></div></pre></td></tr></table></figure>
<p><strong>例子3. 对指定时间范围内的日志进行统计，包括输出INFO，ERROR总数，记录总数，每个订单记录分类统计</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">sed <span class="_">-f</span> demo.sed demolog.log | sort -t@ -k2,2n -k3,3r -k1,1 | awk <span class="_">-f</span> demo.awk</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#demo.awk</span></div><div class="line">BEGIN &#123;</div><div class="line">  FS=<span class="string">"@"</span></div><div class="line">  stime=<span class="string">"2011-08-23 19:57:31"</span></div><div class="line">  etime=<span class="string">"2011-08-23 19:57:37"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="variable">$1</span> &gt; stime &amp;&amp; <span class="variable">$1</span> &lt; etime &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="variable">$3</span> == <span class="string">"INFO"</span>) &#123;info_count++&#125;</div><div class="line">  <span class="keyword">if</span> (<span class="variable">$3</span> == <span class="string">"ERROR"</span>) &#123;error_count++&#125;</div><div class="line"></div><div class="line">  ++total</div><div class="line"></div><div class="line">  status[<span class="variable">$2</span>]=status[<span class="variable">$2</span>]<span class="string">"\t"</span><span class="variable">$1</span><span class="string">"\t"</span><span class="variable">$3</span><span class="string">"\t"</span><span class="variable">$4</span><span class="string">"\n"</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">END &#123;</div><div class="line">  <span class="keyword">for</span>(i <span class="keyword">in</span> status)&#123;</div><div class="line">      <span class="built_in">printf</span>(<span class="string">"id:%s:\n%s\n"</span>,i,status[i])</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">print</span> <span class="string">"order total count:"</span>total</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"INFO count:%d ERROR count:%d\n"</span>,info_count,error_count)</div><div class="line">&#125; &lt;span style=<span class="string">"font-size:18px;"</span>&gt;&lt;strong&gt;</div><div class="line">&lt;/strong&gt;&lt;/span&gt;</div></pre></td></tr></table></figure>
<p><strong>输出：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">id:<span class="number">10117</span>:</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span> INFO  status:attr_ids成功保存为<span class="number">0</span>|<span class="number">100104</span>|<span class="number">0</span>|<span class="number">100105</span>|<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span> ERROR  status:添加属性id，但由于认证分类参数有误默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div><div class="line"></div><div class="line">id:<span class="number">10226</span>:</div><div class="line"></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span> INFO  status:attr_ids不含<span class="number">0</span>跳过</div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">32</span> ERROR  status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100104</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">33</span> ERROR  status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100107</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">33</span> ERROR  status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">46</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">34</span> ERROR  status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100106</span></div><div class="line"><span class="number">2011</span><span class="number">-08</span><span class="number">-23</span> <span class="number">19</span>:<span class="number">57</span>:<span class="number">35</span> ERROR  status:添加属性id，但由于没有属性在该分类下默认取匹配属性名称的第一个属性id：<span class="number">100105</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#这个例子只是举例说明awk的统计用法，实际运用中可能会统计超时的次数，页面访问次数等。</span></div></pre></td></tr></table></figure></p>
<p>awk相关资料：</p>
<pre><code>- 《sed 与 awk》（第二版）
- [awk脑图](http://ww4.sinaimg.cn/large/69693b30gw1dy53b7yjqaj.jpg)
</code></pre><h3 id="6-日志规范化"><a href="#6-日志规范化" class="headerlink" title="6. 日志规范化"></a>6. 日志规范化</h3><p>从前面可以看出，日志文件为了要让后续工具能够对里面的内容进行提取和处理，就必须要让日志文件规范的输出。<br><strong>个人想到有几个点可以规范：</strong></p>
<ol>
<li>记录日志时候可以写入一些特殊的文本语句，一遍与工具的检索和处理。</li>
<li>记录日志最好不要用中文，因为在不同语言环境下对日志的处理可能因为编码不同导致没法处理日志。</li>
</ol>
<p><strong>后面再贴下淘宝中找到的一些打印日志的建议：</strong></p>
<ol>
<li>正常情况下应该返回true, 却返回false的, 反正就是你在对返回值进行检查的时候, 如果不正常, log一下</li>
<li>出现异常的地方, 以前认为hsf.log会帮我们记下所有的异常, 但是这个也不一定可靠, 所以还得我们自己记一下</li>
<li>日志必须包含上下文信息</li>
<li>如果出于统计的需要, 可打可不打</li>
<li>在完成代码之后, 查看一下整个代码结构, 在一些关键的点, 加上日志, 正常的info, 少数情况出现的warning, 异常情况的error或者warning</li>
<li>打印的日志内容要容易查询, 以前我比较倾向于打中文日志, 虽然易读, 但是中文在linux下的搜索统计稍微有些麻烦,所以如果能加上英文标识(比如说用于唯一标识的前缀), 能识别不同日志, 这个对定位也是非常有好处的.</li>
</ol>
<h3 id="7-一些容易遇到的问题"><a href="#7-一些容易遇到的问题" class="headerlink" title="7. 一些容易遇到的问题"></a>7. 一些容易遇到的问题</h3><ul>
<li><p><strong>处理中文出现乱码</strong><br>这个主要是因为你的linux locale的配置，与编辑文件的语言环境，还有你登录ssh客户端的编码规则有关，所以最好还是不用中文记录日志。</p>
</li>
<li><p><strong>正则表达式不同工具的区别</strong><br>这个主要是因为不同工具的正则表达式定义的元字符不同，网上有总结的，可点击<a href="http://blog.csdn.net/ultrani/article/details/6716727" target="_blank" rel="external">正则迷雾参考</a></p>
</li>
</ul>
<h3 id="8-后记"><a href="#8-后记" class="headerlink" title="8. 后记"></a>8. 后记</h3><p>目前只是简单介绍了grep,sed,sort,awk的几个简单应用，实际上的日志监控回根据不同的情景进行不同的处理。比如需要对调用的耗时进行统计（平均时间或者超时记录），对访问量进行统计，但是基本原理都和本文例子出发点一致。本文一方面是为了记录下学习过程中积累的东西，另一方面为了抛砖引玉引起大家对日志记录的关注。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/18/postName/" data-id="civnhqd1u0000n79ksci24v9b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/11/18/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/18/postName/">postName</a>
          </li>
        
          <li>
            <a href="/2016/11/18/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 zhangqishou<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>